function vh(v){return v*window.innerHeight/100}function vw(v){return v*window.innerWidth/100}const colors=["black","#D90022"],barChartD3=d3.select("#svg-bar-chart");let years=[];const yearCurrent=2020;let y=2011;for(;y<=2020;)years.push(y),y++;xScale=d3.scaleBand().domain(years).padding(.2),xAxis=barChartD3.append("g").attr("id","x-axis").attr("class","axis");const yMaxTotal=197,yMaxYTD=90;yScaleTotal=d3.scaleLinear().domain([0,197]),yScaleYTD=d3.scaleLinear().domain([0,90]),yAxis=barChartD3.append("g").attr("id","y-axis").attr("class","axis");const barChartSVG=barChartD3.node();function resetBarChartDimVars(){const barChartSVGStyles=window.getComputedStyle(barChartSVG);marginSVG=parseFloat(barChartSVGStyles.getPropertyValue("margin")),widthSVG=window.innerWidth-2*marginSVG,heightSVG=parseFloat(barChartSVGStyles.getPropertyValue("height"));const heightXAxis=7.1+Math.min(vw(2.5),14);heightBars=heightSVG-heightXAxis}function resetBarChartAxes(){xScale.range([0,widthSVG]),xBandwidth=xScale.bandwidth(),xAxis.attr("transform","translate(0,"+heightBars+")").call(d3.axisBottom(xScale).tickSizeOuter(0)),yScaleTotal.range([heightBars,0]),yScaleYTD.range([heightBars,0])}function resetBarChartDims(){resetBarChartDimVars(),barChartD3.attr("viewBox","0 0 "+widthSVG+" "+heightSVG),resetBarChartAxes()}function setSeriesVars(){seriesNum=document.getElementById("select-series").value,seriesNum<2?yScale=yScaleTotal:yScale=yScaleYTD,dataSeries=d3.stack().keys(seriesNames[seriesNum])(data)}function plotBarChart(){d3.selectAll("#rects-bar-chart rect").remove();for(let j=0;j<colors.length;j++)d3.select("#rects-bar-chart g:nth-child("+(j+1)+")").selectAll("rect").data(dataSeries[j]).enter().append("rect").attr("x",(function(d,i){return xScale(2020-i)})).attr("y",(function(d){return yScale(d[1]-d[0])})).attr("width",xBandwidth).attr("height",(function(d){return heightBars-yScale(d[1]-d[0])}))}function getLabelText(d){return seriesNum<2?yMax=197:yMax=90,h=(d[1]-d[0])/yMax,h<.05?"":d[1]-d[0]}function labelsBarChart(){d3.selectAll(".label-bar-chart").remove();for(let j=0;j<colors.length;j++)d3.select("#labels-bar-chart g:nth-child("+(j+1)+")").selectAll("rect").data(dataSeries[j]).enter().append("text").attr("class","label-bar-chart").attr("x",(function(d,i){return xScale(2020-i)+xBandwidth/2})).attr("y",(function(d){return yScale(d[1]-d[0])+Math.min(vw(3),12)})).text((function(d){return getLabelText(d)}))}function getRectBlack(rect){const x=rect.attributes.x.value;return d3.select('#rects-bar-chart-black rect[x="'+x+'"]')}function rectMouseenter(rect){const rectBlack=getRectBlack(rect),h=Number(rectBlack.attr("height"));rectBlack.attr("stroke","black"),rectBlack.attr("stroke-width","1.5vh"),rectBlack.attr("stroke-opacity","0.4"),rectBlack.attr("stroke-dasharray",xBandwidth+h-.1+" "+(xBandwidth+.2))}function rectMouseout(rect){const rectBlack=getRectBlack(rect);rectBlack.attr("stroke-width","0")}function bindRectHoverListeners(){const rects=document.querySelectorAll("#rects-bar-chart rect");rects.forEach((function(rect){rect.addEventListener("mouseover",(function(){rectMouseenter(rect)})),rect.addEventListener("mouseout",(function(){rectMouseout(rect)}))}))}function bindRectClickListeners(){d3.selectAll("#rects-bar-chart rect").on("click",(function(d){window.top.yearClickedBarChart=d.data.year}))}function resetLegendDimVars(){incidentsTextWidth=7*Math.min(vw(2.5),14),halfWidth=parseFloat(window.getComputedStyle(barChartSVG).getPropertyValue("width"))/2}function resetLegendDims(){resetLegendDimVars(),legendD3.attr("width",widthSVG).attr("height",marginSVG)}function getLegendRectX(i){switch(i){case 0:return halfWidth-2.5*marginSVG-incidentsTextWidth;case 1:return halfWidth+marginSVG}}function plotLegend(){d3.selectAll(".rect-legend").remove(),d3.selectAll(".legend-entry").append("rect").attr("class","rect-legend").attr("x",(function(d,i){return getLegendRectX(i)})).attr("width",marginSVG).attr("height",marginSVG).attr("fill",(function(d,i){return colors[i]}))}function getLegendLabelX(i){switch(i){case 0:return halfWidth-marginSVG-incidentsTextWidth;case 1:return halfWidth+2.5*marginSVG}}function getLegendLabelText(i){switch(i){case 0:return labelBlack;case 1:return labelRed}}function labelsLegend(){"0"==seriesNum||"2"==seriesNum?(labelBlack="Total Incidents",labelRed="Homicide Incidents"):(labelBlack="Total Victims",labelRed="Victims Killed"),d3.selectAll(".label-legend").remove(),d3.selectAll(".legend-entry").append("text").attr("class","label-legend").text((function(d,i){return getLegendLabelText(i)})).attr("x",(function(d,i){return getLegendLabelX(i)})).attr("y",marginSVG/2).attr("dy",".35em")}function buildBarChart(){resetBarChartDims(),setSeriesVars(),plotBarChart(),labelsBarChart(),bindRectHoverListeners(),bindRectClickListeners()}function buildLegend(){resetLegendDims(),plotLegend(),labelsLegend()}function handlerChangeSeries(){buildBarChart(),labelsLegend()}function redrawSVG(){window.innerWidth>=300&&(resetBarChartDims(),plotBarChart(),labelsBarChart(),bindRectHoverListeners(),bindRectClickListeners(),buildLegend())}barChartD3.append("g").attr("id","rects-bar-chart").selectAll("g").data(colors).enter().append("g").attr("id",(function(d){return"rects-bar-chart-"+colors[d]})).attr("fill",(function(d,i){return colors[i]})).selectAll("rect").data((function(d){return d})).enter(),barChartD3.append("g").attr("id","labels-bar-chart").selectAll("g").data(colors).enter().append("g").attr("id",(function(d){return"labels-bar-chart-"+colors[d]})),legendD3=d3.select("#svg-legend"),legendD3.selectAll("g").data(colors).enter().append("g").attr("id",(function(d,i){return"legend-entry-"+colors[i]})).attr("class","legend-entry"),d3.csv("data/yearlyData.csv").then((function(data){window.data=data,seriesNames=[data.columns.slice(1,3),data.columns.slice(3,5),data.columns.slice(5,7),data.columns.slice(7,9)],buildBarChart(),buildLegend()})),document.getElementById("select-series").addEventListener("change",handlerChangeSeries),window.addEventListener("resize",redrawSVG);