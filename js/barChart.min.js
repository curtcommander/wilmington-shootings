function vh(v){return v*window.innerHeight/100}function vw(v){return v*window.innerWidth/100}const colors=["black","#D90022"],barChartD3=d3.select("#svg-bar-chart"),barChartSVG=barChartD3.node(),heightXAxis=7.1+Math.min(vw(2.5),14);function resetDimVars(){barChartSVGStyles=window.getComputedStyle(barChartSVG),marginSVG=parseFloat(barChartSVGStyles.getPropertyValue("margin")),widthSVG=window.innerWidth-2*marginSVG,heightSVG=parseFloat(barChartSVGStyles.getPropertyValue("height")),heightBars=heightSVG-heightXAxis}let years=[];const yearCurrent=2020;let y=2011;for(;y<=2020;)years.push(y),y++;xScale=d3.scaleBand().domain(years).padding(.2),xAxis=barChartD3.append("g").attr("id","x-axis").attr("class","axis");const yMaxTotal=197,yMaxYTD=90;function resetAxes(){xScale.range([0,widthSVG]),xAxis.attr("transform","translate(0,"+heightBars+")").call(d3.axisBottom(xScale).tickSizeOuter(0)),xBandwidth=xScale.bandwidth(),yScaleTotal.range([heightBars,0]),yScaleYTD.range([heightBars,0])}function resetDims(){resetDimVars(),barChartD3.attr("viewBox","0 0 "+widthSVG+" "+heightSVG),resetAxes()}function setSeriesVars(){seriesNum=document.getElementById("select-series").value,seriesNum<2?yScale=yScaleTotal:yScale=yScaleYTD,dataSeries=d3.stack().keys(seriesNames[seriesNum])(data)}function plotBarChart(){const rectsBarChart=document.getElementById("rects-bar-chart");rectsBarChart&&rectsBarChart.parentNode.removeChild(rectsBarChart),barChartD3.append("g").attr("id","rects-bar-chart").selectAll("g").data(dataSeries).enter().append("g").attr("id",(function(d,i){return"rects-bar-chart-"+colors[i]})).attr("fill",(function(d,i){return colors[i]})).selectAll("rect").data((function(d){return d})).enter().append("rect").attr("x",(function(d,i){return xScale(2020-i)})).attr("y",(function(d){return yScale(d[1]-d[0])})).attr("width",xBandwidth).attr("height",(function(d){return heightBars-yScale(d[1]-d[0])}))}function getLabelText(d){return seriesNum<2?yMax=197:yMax=90,h=(d[1]-d[0])/yMax,h<.05?"":d[1]-d[0]}function labelsBarChart(){const labels=document.querySelector("#labels-bar-chart");labels&&labels.parentNode.removeChild(labels),barChartD3.append("g").attr("id","labels-bar-chart").selectAll("g").data(dataSeries).enter().append("g").attr("id",(function(d,i){return"labels-bar-chart-"+colors[i]})).selectAll("text").data((function(d){return d})).enter().append("text").attr("class","label-bar-chart").attr("x",(function(d,i){return xScale(2020-i)+xBandwidth/2})).attr("y",(function(d){return yScale(d[1]-d[0])+Math.min(vw(3),12)})).text((function(d){return getLabelText(d)})).attr("text-anchor","middle").attr("fill","white").attr("pointer-events","none").style("font-size","min(2.5vw, 14px)")}function getRectBlack(rect){const x=rect.attributes.x.value;return d3.select('#rects-bar-chart-black rect[x="'+x+'"]')}function rectMouseenter(rect){rectBlack=getRectBlack(rect),h=Number(rectBlack.attr("height")),rectBlack.attr("stroke","black"),rectBlack.attr("stroke-width","1.5vh"),rectBlack.attr("stroke-opacity","0.4"),rectBlack.attr("stroke-dasharray",xBandwidth+h-.1+" "+(xBandwidth+.2))}function rectMouseout(rect){rectBlack=getRectBlack(rect),rectBlack.attr("stroke-width","0")}function bindRectHoverListeners(){rects=document.querySelectorAll("#svg-bar-chart rect"),rects.forEach((function(rect){rect.addEventListener("mouseover",(function(){rectMouseenter(rect)})),rect.addEventListener("mouseout",(function(){rectMouseout(rect)}))}))}function bindRectClickListeners(){d3.selectAll("rect").on("click",(function(d){window.top.yearClickedBarChart=d.data.year}))}function getLegendRectX(i){switch(i){case 0:return halfWidth-2.5*marginSVG-incidentsTextWidth;case 1:return halfWidth+marginSVG}}function plotLegend(){halfWidth=parseFloat(window.getComputedStyle(barChartSVG).getPropertyValue("width"))/2,incidentsTextWidth=7*Math.min(vw(2.5),14),legendEntries=legendD3.node().querySelectorAll(".legend-entry"),legendEntries.length>0&&legendEntries.forEach((function(legendEntry){legendEntry.parentNode.removeChild(legendEntry)})),legendD3.attr("width",widthSVG).attr("height",marginSVG+3).selectAll("g").data(colors).enter().append("g").attr("id",(function(d,i){return"legend-entry-"+colors[i]})).attr("class","legend-entry").attr("font-size","min(2.5vw, 14px)").append("rect").attr("class","rect-legend").attr("x",(function(d,i){return getLegendRectX(i)})).attr("width",marginSVG).attr("height",marginSVG).style("fill",(function(d,i){return colors[i]}))}function getLegendLabelX(i){switch(i){case 0:return halfWidth-marginSVG-incidentsTextWidth;case 1:return halfWidth+2.5*marginSVG}}function getLegendLabelText(i){switch(i){case 0:return labelBlack;case 1:return labelRed}}function labelsLegend(){"0"==seriesNum||"2"==seriesNum?(labelBlack="Total Incidents",labelRed="Homicide Incidents"):(labelBlack="Total Victims",labelRed="Victims Killed");const labels=document.querySelectorAll(".label-legend");labels&&labels.forEach((function(label){label.parentNode.removeChild(label)})),d3.selectAll(".legend-entry").append("text").attr("class","label-legend").text((function(d,i){return getLegendLabelText(i)})).attr("x",(function(d,i){return getLegendLabelX(i)})).attr("y",marginSVG/2).attr("dy",".35em").attr("font-size","1.2em")}function buildBarChart(){resetDims(),setSeriesVars(),plotBarChart(),labelsBarChart(),bindRectHoverListeners(),bindRectClickListeners()}function handlerChangeSeries(){buildBarChart(),labelsLegend()}yScaleTotal=d3.scaleLinear().domain([0,197]),yScaleYTD=d3.scaleLinear().domain([0,90]),yAxis=barChartD3.append("g").attr("id","y-axis").attr("class","axis"),legendD3=d3.select("#svg-legend"),window.addEventListener("resize",(function(){window.innerWidth>=300&&(resetDims(),plotBarChart(),labelsBarChart(),bindRectHoverListeners(),bindRectClickListeners(),plotLegend(),labelsLegend())})),d3.csv("data/yearlyData.csv").then((function(data){window.data=data,seriesNames=[data.columns.slice(1,3),data.columns.slice(3,5),data.columns.slice(5,7),data.columns.slice(7,9)],buildBarChart(),plotLegend(),labelsLegend()})),document.getElementById("select-series").addEventListener("change",handlerChangeSeries);