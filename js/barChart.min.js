function setSeriesVal(){for(i in seriesSelected=$(".ui-selectmenu-text").html(),seriesArray)if(seriesArray[i]==seriesSelected){parent.seriesVal=i;break}}function changeSeries(){setSeriesVal(),plot(data),addLabels(dataset),hoverHandler(),legendTxt()}function vh(v){var h;return v*Math.max(document.documentElement.clientHeight,window.innerHeight||0)/100}seriesArray=["Incidents","Victims","Incidents YTD","Victims YTD"],$("#seriesSelect").selectmenu({change:changeSeries}),$(".ui-icon").remove(),$("#seriesSelect option").each((function(index){index==parent.seriesVal&&($("#seriesSelect").val(index),$("#seriesSelect").selectmenu("refresh"))}));var margin={top:vh(3),right:vh(3),bottom:vh(3),left:vh(3)},legend=d3.select("#legendSVG").attr("display","block").style("width",$(window).width()-1).style("height","20px"),verticalSpace=$(window).height()-parseInt($("#container").css("padding-top"))-parseInt($("#container").css("padding-bottom"))-20,svg=d3.select("#mainSVG").attr("display","block").style("width",$(window).width()-1).style("height",verticalSpace-$("#containerSelect").height()-margin.bottom),width=$("#mainSVG").width()-margin.left-margin.right,height=$("#mainSVG").height()-margin.top-margin.bottom,container=svg.append("g").attr("class","containerSVG").attr("transform","translate("+margin.left+","+-1*margin.top+")");$("#container").css("transform","translate(0,"+($("body").height()-$("#container").outerHeight())/2+"px"),yMaxTotal=217,yMaxYTD=92;const yScaleTotal=d3.scaleLinear().range([height,0]).domain([0,yMaxTotal]),yScaleYTD=d3.scaleLinear().range([height,0]).domain([0,yMaxYTD]);var yAxis=container.append("g").attr("class","Yaxis");for(years=[],yearCurrent=2020,y=2011;y<=yearCurrent;)years.push(y),y++;var xScale=d3.scaleBand().range([0,width]).domain(years).padding(.2),xAxis=container.append("g").attr("class","Xaxis").attr("transform","translate(0,"+(height+margin.top-margin.bottom)+")").call(d3.axisBottom(xScale).tickSizeOuter(0));function plot(data){series=[data.columns.slice(1,3),data.columns.slice(3,5),data.columns.slice(5,7),data.columns.slice(7,9)],seriesNum=Number(parent.seriesVal),seriesNum<2?yScale=yScaleTotal:yScale=yScaleYTD,dataset=d3.stack().keys(series[seriesNum])(data),container.selectAll(".remove").remove(),container.append("g").selectAll("g").data(dataset).enter().append("g").attr("fill",(function(d,i){return colors[i]})).attr("class","remove").selectAll("rect").data((function(d){return d})).enter().append("rect").attr("class","remove").attr("class",(function(d){return 0==d[0]?"remove black":"remove red"})).attr("width",xScale.bandwidth()).attr("x",(function(d,i){return xScale(yearCurrent-i)})).attr("height",(function(d){return height-yScale(d[1]-d[0])})).attr("y",(function(d){return yScale(d[1]-d[0])+margin.top-margin.bottom}))}function addLabels(dataset){seriesNum=Number(parent.seriesVal),seriesNum<2?yScale=yScaleTotal:yScale=yScaleYTD,container.selectAll(".label").remove(),container.append("g").selectAll(".label").data(dataset).enter().append("g").selectAll("text").data((function(d){return d})).enter().append("text").text((function(d){return seriesNum<2?yMax=yMaxTotal:yMax=yMaxYTD,h=(d[1]-d[0])/yMax,h<.05?"":d[1]-d[0]})).attr("class","label").attr("text-anchor","middle").attr("fill","white").style("font-size","3vh").attr("x",(function(d,i){return xScale(yearCurrent-i)+xScale.bandwidth()/2})).attr("y",(function(d){return yScale(d[1]-d[0])+margin.top-.5}))}function hoverHandler(){$("rect").hover((function(){x=$(this).attr("x"),target=$('rect.black[x="'+x+'"]'),h=Number(d3.select('rect.black[x="'+x+'"]').attr("height")),target.css({stroke:"black","stroke-opacity":"0.4","stroke-width":"1.5vh","stroke-dasharray":w+h-.1+" "+(w+.2)})}),(function(){x=$(this).attr("x"),$('rect.black[x="'+x+'"]').css({"stroke-width":"0"})}))}function getTextWidth(text,font){var canvas,context=(getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas"))).getContext("2d"),metrics;return context.font=font,context.measureText(text).width}$((function firefox(){if(-1!=navigator.userAgent.indexOf("Firefox")){function adjustFirefox(){$("select").css({color:"transparent","text-shadow":"0 0 0 #000"})}adjustFirefox()}})),w=xScale.bandwidth(),colors=["black","#D90022"],d3.csv("data/yearlyData.csv").then((function(data){function passYearParent(){d3.selectAll("rect.remove").on("click",(function(d){window.top.yearClicked=d.data.year}))}return window.data=data,plot(data),hoverHandler(),passYearParent(),d3.select("ul").on("click",passYearParent),dataset})).then((function(dataset){addLabels(dataset)})),scalar=18*$("#mainSVG").height()/544+5,margin.legend=vh(3),halfWidth=$("#mainSVG").width()/2;var legendEntries=legend.selectAll(".legend").data(colors).enter().append("g").attr("class","legend").attr("id",(function(d,i){return i})).attr("font-size","3vh");function legendTxt(){"0"==parent.seriesVal||"2"==parent.seriesVal?(case0="Incidents",case1="Homicide Incidents"):(case0="Victims",case1="Killed"),legendEntries.selectAll("text").remove(),legendEntries.append("text").attr("y",scalar/2).attr("dy",".35em").attr("font-size","1.2em").text((function(d,i){switch(i){case 0:return case0;case 1:return case1}})).attr("x",(function(d,i){return 0==i?halfWidth-margin.legend-getTextWidth("Incidents","normal "+$("#0 text").css("font-size")+" Roboto"):halfWidth+margin.legend+1.5*scalar}))}legendTxt(),legendEntries.append("rect").attr("x",(function(d,i){return 0==i?halfWidth-getTextWidth("Incidents","normal "+$("#0 text").css("font-size")+" Roboto")-margin.legend-1.5*scalar:halfWidth+margin.legend})).attr("width",scalar).attr("height",scalar).style("fill",(function(d,i){return colors[i]}));