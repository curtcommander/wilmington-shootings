const center=L.latLng(39.7461,-75.5498),zoom=14,map=L.map("map").setView(center,14).setMaxBounds(L.latLngBounds([[39.8261,-75.4698],[39.6661,-75.6298]]));function getIconSize(){const mapStyles=window.getComputedStyle(document.getElementById("map")),mapWidth=parseFloat(mapStyles.getPropertyValue("width")),mapHeight=parseFloat(mapStyles.getPropertyValue("height")),vmin=Math.min(mapWidth,mapHeight),currentZoom=map.getZoom();return.03*vmin+1.2*currentZoom}L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>\n                 <div>Icons made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>',minZoom:13,maxZoom:18,ext:"png"}).addTo(map),window.onload=function(){map.invalidateSize()};const svgTemplate=L.Util.template(' <svg version="1.1" class="leaflet-data-marker" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 15.847 15.847" style="enable-background:new 0 0 15.847 15.847;" xml:space="preserve">     <path d="M15.847,5.228V4.052h-0.065V2.931h-0.064V2.534H15.26V2.93c0,0-11.083,0.078-13.018,0         c-0.296,0-1.986,0.167-0.291,2.773c0,0,0.77,1.168-0.285,2.471c-1.041,1.284-1.51,3.885-1.632,4.671H0v0.468h4.803v-0.468v-0.43         c-2.075,0.382,1.434-4.447,1.278-3.634c0.113,0.029,0.23,0.047,0.352,0.047h1.25c0.772,0,1.797-0.826,1.797-1.599         c0-0.335-0.118-0.642-0.314-0.883h6.185l0.2-0.736h0.262V5.254H15.77l0.011-0.026H15.847z M7.685,8.144h-1.25         c-0.092,0-0.181-0.015-0.265-0.04c0.073-0.429,0.129-0.813,0.169-1.112c0.105,0.347,0.31,0.71,0.713,0.867         C7.08,7.87,7.109,7.875,7.138,7.875c0.094,0,0.184-0.058,0.221-0.15c0.047-0.123-0.014-0.26-0.136-0.308         c-0.417-0.162-0.5-0.792-0.516-1.068h1.205c0.393,0.102,0.686,0.459,0.686,0.883C8.598,7.734,8.188,8.144,7.685,8.144z         M14.098,5.612H7.924l1.072-0.357h5.102C14.098,5.255,14.098,5.612,14.098,5.612z"/> </svg>'),icon=L.divIcon({className:"leaflet-data-marker",html:svgTemplate});function resizeIcons(){const size=getIconSize(),sizeCSS=String(size)+"px";document.querySelectorAll("#map svg:not(.leaflet-zoom-animated)").forEach((function(svg){svg.style.width=sizeCSS,svg.style.height=sizeCSS})),icon.options.iconSize=[size,size]}function loadCurrentData(response){return new Promise((function(resolve){response.arrayBuffer().then((function(buffer){const blob=new Blob([buffer],{type:"application/zip"}),zip=new JSZip;zip.loadAsync(blob).then((function(zip){return zip.file("incidentDataCurrent.csv").async("string")})).then((function(dataAsString){currentData=d3.csvParse(dataAsString),resolve(currentData)}))}))}))}map.on("zoomstart",resizeIcons).on("resize",resizeIcons);const markers=L.layerGroup();function plotCurrentData(currentData){return new Promise((function(resolve){for(i=0;i<currentData.length;i++)L.marker([currentData[i].LAT,currentData[i].LONG],{icon:icon}).on("click",markerClickHandler).addTo(markers);markers.addTo(map),resizeIcons(),resolve(currentData)}))}let dataYearly={},yearDataYearly=2011;const yearCurrent=document.querySelector('#date-val option[selected="selected"]').value;for(;yearDataYearly<=yearCurrent;)dataYearly[yearDataYearly]=[],yearDataYearly++;let year=Number(yearCurrent);function prepareDataObjects(intialData){for(dataChron=currentData,i=0;i<dataChron.length;i++){let d=dataChron[i];delete d.YEAR,dataYearly[year].push({LAT:d.LAT,LONG:d.LONG,HTML:d.HTML})}fetch("data/incidentDataPrevious.zip").then((function(response){response.arrayBuffer().then((function(buffer){var blob=new Blob([buffer],{type:"application/zip"}),zip;(new JSZip).loadAsync(blob).then((function(zip){return incidentData=zip.file("incidentDataPrevious.csv").async("string")})).then((function(dataAsString){return d3.csvParse(dataAsString)})).then((function(data){data.forEach((function(d){dataYearly[d.YEAR].push({LAT:d.LAT,LONG:d.LONG,HTML:d.HTML}),delete d.YEAR,dataChron.push(d)}))}))}))}))}function plotMarkersYear(){markers.clearLayers(),year=Number(document.getElementById("date-val").value);const dataYear=dataYearly[year];for(i=0;i<dataYear.length;i++)L.marker([dataYear[i].LAT,dataYear[i].LONG],{icon:icon}).on("click",markerClickHandler).addTo(markers);markers.addTo(map),resizeIcons()}function plotMarkersCustomDate(){markers.clearLayers();const fromDate=adjustTimeZone(new Date(document.getElementById("date-range-from").value)),toDate=adjustTimeZone(new Date(document.getElementById("date-range-to").value));for(i=0;i<dataChron.length;i++){let d=dataChron[i];if(d.DATE=adjustTimeZone(new Date(d.DATE)),d.DATE>=fromDate)d.DATE<=toDate&&L.marker([d.LAT,d.LONG],{icon:icon}).on("click",markerClickHandler).addTo(markers);else if(d.Date<fromDate)break}markers.addTo(map),resizeIcons()}function adjustTimeZone(d){return new Date(d.getTime()+6e4*d.getTimezoneOffset())}function getYear(){return document.getElementById("date-val").value}function dateTypeChangeHandler(){const dateType=document.getElementById("date-type").value;if("year"==dateType){const dateVal=document.getElementById("date-val");dateVal.style.display="unset",document.getElementById("date-range").style.display="none",year=Number(document.getElementById("date-range-from").value.substring(6)),document.getElementById("date-val").addEventListener("change",(function(){markers.clearLayers(),plotMarkersYear()}))}else document.getElementById("date-val").style.display="none",document.getElementById("date-range").style.display="block",year=getYear(),flatpickr("#date-range-from",{dateFormat:"m/d/Y",minDate:"01/01/2011",maxDate:"today",defaultDate:"01/01/"+year}),flatpickr("#date-range-to",{dateFormat:"m/d/Y",minDate:document.getElementById("date-range-from").value,maxDate:"today",defaultDate:year==yearCurrent?"today":"12/31/"+year}),document.querySelectorAll(".custom-date").forEach((function(customDate){customDate.addEventListener("change",plotMarkersCustomDate)}))}function unselectMarker(){const markerSelectedOld=document.querySelector(".marker-selected");markerSelectedOld&&markerSelectedOld.classList.remove("marker-selected")}function markerClickHandler(e){const markerSelectedOld=document.querySelector(".marker-selected"),markerSelectedNew=e.target._icon;if(markerSelectedOld==markerSelectedNew)defaultSidePanel();else{const latlngClicked=this._latlng,latClicked=latlngClicked.lat,longClicked=latlngClicked.lng,dateType=document.getElementById("date-type").value;if("year"==dateType)var dataLoop=dataYearly[year];else var dataLoop=dataChron;for(i=0;i<dataLoop.length;i++)if(d=dataLoop[i],d.LAT==latClicked&&d.LONG==longClicked){document.getElementById("side-panel-default").style.display="none";const dNode=document.createRange().createContextualFragment(d.HTML);document.getElementById("side-panel").append(dNode),unselectMarker(),markerSelectedNew.classList.add("marker-selected");break}}}function defaultSidePanel(){unselectMarker(),document.getElementById("side-panel-default").style.display="unset";const incident=document.querySelector(".incident");incident.parentNode.removeChild(incident)}fetch("data/incidentDataCurrent.zip").then(loadCurrentData).then(plotCurrentData).then(prepareDataObjects),document.getElementById("date-val").addEventListener("change",plotMarkersYear),document.getElementById("date-type").addEventListener("change",dateTypeChangeHandler),map.on("click",defaultSidePanel),bindRectsClickHandler=function(){barChart.contentDocument.querySelectorAll("rect").forEach((function(rect){rect.addEventListener("click",(function(){"year"==document.getElementById("date-type").value?(document.getElementById("date-val").value=window.yearClicked,plotMarkersYear()):(fromDate="01/01/"+window.yearClicked,document.getElementById("date-range-from").value=fromDate,window.yearClicked==yearCurrent?(today=new Date,toDate=today.getMonth()+"/"+today.getDate()+"/"+yearCurrent):toDate="12/31/"+year,document.getElementById("date-range-to").value=fromDate,plotMarkersCustomDate())}))}))},barChart=window.frames.barChart,barChart.onload=function(){bindRectsClickHandler(),barChart.contentDocument.querySelector("#select-series").addEventListener("change",bindRectsClickHandler)};