const center=L.latLng(39.7461,-75.5498),zoom=14,map=L.map("map").setView(center,14).setMaxBounds(L.latLngBounds([[39.8261,-75.4698],[39.6661,-75.6298]]));L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>\n                 <div>Icons made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>',minZoom:13,maxZoom:18,ext:"png"}).addTo(map),window.addEventListener("load",(function(){map.invalidateSize()}));const svgTemplate=L.Util.template(' <svg version="1.1" class="leaflet-data-marker" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 15.847 15.847" style="enable-background:new 0 0 15.847 15.847;" xml:space="preserve">     <path d="M15.847,5.228V4.052h-0.065V2.931h-0.064V2.534H15.26V2.93c0,0-11.083,0.078-13.018,0         c-0.296,0-1.986,0.167-0.291,2.773c0,0,0.77,1.168-0.285,2.471c-1.041,1.284-1.51,3.885-1.632,4.671H0v0.468h4.803v-0.468v-0.43         c-2.075,0.382,1.434-4.447,1.278-3.634c0.113,0.029,0.23,0.047,0.352,0.047h1.25c0.772,0,1.797-0.826,1.797-1.599         c0-0.335-0.118-0.642-0.314-0.883h6.185l0.2-0.736h0.262V5.254H15.77l0.011-0.026H15.847z M7.685,8.144h-1.25         c-0.092,0-0.181-0.015-0.265-0.04c0.073-0.429,0.129-0.813,0.169-1.112c0.105,0.347,0.31,0.71,0.713,0.867         C7.08,7.87,7.109,7.875,7.138,7.875c0.094,0,0.184-0.058,0.221-0.15c0.047-0.123-0.014-0.26-0.136-0.308         c-0.417-0.162-0.5-0.792-0.516-1.068h1.205c0.393,0.102,0.686,0.459,0.686,0.883C8.598,7.734,8.188,8.144,7.685,8.144z         M14.098,5.612H7.924l1.072-0.357h5.102C14.098,5.255,14.098,5.612,14.098,5.612z"/> </svg>'),icon=L.divIcon({className:"leaflet-data-marker",html:svgTemplate}),mapElement=document.getElementById("map");function getIconSize(){const mapStyles=window.getComputedStyle(mapElement),mapWidth=parseFloat(mapStyles.getPropertyValue("width")),mapHeight=parseFloat(mapStyles.getPropertyValue("height")),vmin=Math.min(mapWidth,mapHeight),currentZoom=map.getZoom();return.03*vmin+1.2*currentZoom}function adjustIcons(){const size=getIconSize(),sizeCSS=String(size)+"px",anchorCSS=-.5*size+"px";document.querySelectorAll(".leaflet-marker-icon").forEach((function(marker){const svgStyle=marker.querySelector("svg").style;svgStyle.width=sizeCSS,svgStyle.height=sizeCSS,marker.style.marginLeft=anchorCSS,marker.style.marginTop=anchorCSS})),icon.options.iconSize=[size,size]}map.on("zoomstart",adjustIcons).on("resize",adjustIcons);const markers=L.layerGroup();function plotCurrentData(currentData){adjustIcons();for(let i=0;i<currentData.length;i++){const d=currentData[i];L.marker([d.LAT,d.LONG],{icon:icon}).on("click",markerClickHandler).addTo(markers)}markers.addTo(map)}let dataYearly={},yearDataYearly=2011;const yearCurrent=document.querySelector('#date-year option[selected="selected"]').value;for(;yearDataYearly<=yearCurrent;)dataYearly[yearDataYearly]=[],yearDataYearly++;let year=yearCurrent;function prepareDataObjects(currentData){dataChron=currentData,dataYear=dataYearly[year];for(let i=0;i<dataChron.length;i++){let d=dataChron[i];delete d.YEAR,dataYear.push({LAT:d.LAT,LONG:d.LONG,HTML:d.HTML})}d3.csv("/data/incidentDataCurrent.csv").then((function(data){data.forEach((function(d){dataYearly[d.YEAR].push({LAT:d.LAT,LONG:d.LONG,HTML:d.HTML}),delete d.YEAR,dataChron.push(d)}))}))}d3.csv("/data/incidentDataCurrent.csv").then((function(currentData){plotCurrentData(currentData),prepareDataObjects(currentData)}));const dateType=document.getElementById("date-type"),dateYear=document.getElementById("date-year"),dateCustom=document.getElementById("date-custom"),dateCustomFrom=document.getElementById("date-custom-from"),dateCustomTo=document.getElementById("date-custom-to"),sidePanel=document.getElementById("side-panel"),sidePanelDefault=document.getElementById("side-panel-default"),barChart=document.getElementById("barChart"),today=new Date;function plotMarkersYear(){markers.clearLayers();const dataYear=dataYearly[year];for(i=0;i<dataYear.length;i++)L.marker([dataYear[i].LAT,dataYear[i].LONG],{icon:icon}).on("click",markerClickHandler).addTo(markers);markers.addTo(map)}function adjustTimeZoneOffset(d){return new Date(d.getTime()+6e4*d.getTimezoneOffset())}function plotMarkersCustomDate(){markers.clearLayers();const fromDate=adjustTimeZoneOffset(new Date(dateCustomFrom.value)),toDate=adjustTimeZoneOffset(new Date(dateCustomTo.value));for(i=0;i<dataChron.length;i++){let d=dataChron[i];if(d.DATE=adjustTimeZoneOffset(new Date(d.DATE)),d.DATE>=fromDate)d.DATE<=toDate&&L.marker([d.LAT,d.LONG],{icon:icon}).on("click",markerClickHandler).addTo(markers);else if(d.Date<fromDate)break}markers.addTo(map)}dateYear.addEventListener("change",(function(){year=this.value,plotMarkersYear()})),dateCustomFrom.addEventListener("change",plotMarkersCustomDate),dateCustomTo.addEventListener("change",plotMarkersCustomDate),Date.prototype.formatMMDDYYYY=function(){return this.getMonth()+1+"/"+this.getDate()+"/"+this.getFullYear()};const fromDateOptions={dateFormat:"m/d/Y",minDate:"01/01/2011",maxDate:null,defaultDate:null},toDateOptions={dateFormat:"m/d/Y",minDate:null,maxDate:(new Date).formatMMDDYYYY(),defaultDate:null};function updateDatePickers(){const fromDate=dateCustomFrom.value,toDate=dateCustomTo.value;fromDateOptions.maxDate=toDate,fromDateOptions.defaultDate=fromDate,flatpickr("#date-custom-from",fromDateOptions),toDateOptions.minDate=fromDate,toDateOptions.defaultDate=toDate,flatpickr("#date-custom-to",toDateOptions)}function dateCustomFromChangeHandler(){const fromDate=new Date(dateCustomFrom.value);fromDate<new Date(fromDateOptions.minDate)?(dateCustomFrom.value=fromDateOptions.minDate,dateCustomFrom.dispatchEvent(new Event("change")),fromDateOptions.defaultDate=fromDateOptions.minDate,flatpickr("#date-custom-from",fromDateOptions)):fromDate>new Date(dateCustomTo.value)&&(dateCustomFrom.value=dateCustomTo.value,fromDateOptions.defaultDate=dateCustomTo.value,dateCustomFrom.dispatchEvent(new Event("change")),flatpickr("#date-custom-from",fromDateOptions)),toDateOptions.minDate=dateCustomFrom.value,toDateOptions.defaultDate=dateCustomTo.value,flatpickr("#date-custom-to",toDateOptions)}function dateCustomToChangeHandler(){const toDate=new Date(dateCustomTo.value);toDate<new Date(dateCustomFrom.value)?(dateCustomTo.value=dateCustomFrom.value,dateCustomTo.dispatchEvent(new Event("change")),toDateOptions.defaultDate=dateCustomFrom.value,flatpickr("#date-custom-to",toDateOptions)):toDate>new Date(toDateOptions.maxDate)&&(dateCustomTo.value=toDateOptions.maxDate,dateCustomTo.dispatchEvent(new Event("change")),toDateOptions.defaultDate=toDateOptions.maxDate,flatpickr("#date-custom-to",toDateOptions)),fromDateOptions.maxDate=dateCustomTo.value,fromDateOptions.defaultDate=dateCustomFrom.value,flatpickr("#date-custom-from",fromDateOptions)}function layoutAdjustments(){if(window.innerWidth<800){mapElement.style.height="";const heightTop=parseFloat(window.getComputedStyle(document.getElementById("top")).getPropertyValue("height")),heightMap=parseFloat(window.getComputedStyle(mapElement).getPropertyValue("height")),heightSidePanel=window.innerHeight-heightTop-heightMap;sidePanel.style.height=heightSidePanel+"px"}else{const heightTop=parseFloat(window.getComputedStyle(document.getElementById("top")).getPropertyValue("height")),heightSidePanel=Math.max(window.innerHeight-heightTop,364);mapElement.style.height=heightSidePanel+"px",sidePanel.style.height=heightSidePanel+"px",barChart.style.top=(heightSidePanel-64-Math.max(.5*window.innerHeight,250))/2+"px"}}function dateTypeChangeHandler(){"custom"==dateType.value?(dateYear.style.display="none",dateCustom.style.display="block",dateCustomFrom.value="1/1/"+year,dateCustomTo.value=year==yearCurrent?String(today.getMonth()+1)+"/"+today.getDate()+"/"+year:"12/31/"+year,updateDatePickers()):(dateYear.style.display="unset",dateCustom.style.display="none",year=dateCustomFrom.value.substring(6),dateYear.value=year,plotMarkersYear()),layoutAdjustments()}function unselectMarker(){const markerSelectedOld=document.querySelector(".marker-selected");markerSelectedOld&&markerSelectedOld.classList.remove("marker-selected")}function selectMarker(){unselectMarker(),markerSelectedNew.classList.add("marker-selected"),sidePanelDefault.style.display="none";const incident=document.querySelector(".incident");incident&&incident.parentNode.removeChild(incident);const dNode=document.createRange().createContextualFragment(d.HTML);sidePanel.append(dNode)}function markerClickHandler(e){const markerSelectedOld=document.querySelector(".marker-selected");if(markerSelectedNew=e.target._icon,markerSelectedOld==markerSelectedNew)defaultSidePanel();else{const latlngClicked=this._latlng,latClicked=latlngClicked.lat,longClicked=latlngClicked.lng;if("year"==dateType.value){const dataYear=dataYearly[year];for(let i=0;i<dataYear.length;i++)if(d=dataYear[i],d.LAT==latClicked&&d.LONG==longClicked){selectMarker();break}}else{const fromDate=adjustTimeZoneOffset(new Date(dateCustomFrom.value)),toDate=adjustTimeZoneOffset(new Date(dateCustomTo.value));for(let i=0;i<dataChron.length;i++){d=dataChron[i];const dateIncident=adjustTimeZoneOffset(new Date(d.DATE));if(d.LAT==latClicked&&d.LONG==longClicked&&dateIncident>=fromDate&&dateIncident<=toDate){selectMarker();break}}}}}function defaultSidePanel(){if("none"==sidePanelDefault.style.display){unselectMarker(),sidePanelDefault.style.display="unset";const incident=document.querySelector(".incident");incident.parentNode.removeChild(incident)}}if(dateCustomFrom.addEventListener("change",dateCustomFromChangeHandler),dateCustomTo.addEventListener("change",dateCustomToChangeHandler),window.addEventListener("resize",layoutAdjustments),dateType.addEventListener("change",dateTypeChangeHandler),map.on("click",defaultSidePanel),window.outerWidth>=800){function bindRectsClickHandler(){rects=barChart.contentDocument.querySelectorAll("#svg-bar-chart rect"),rects.forEach((function(rect){rect.addEventListener("click",(function(){"year"==dateType.value?year!=window.yearClickedBarChart&&(year=window.yearClickedBarChart,dateYear.value=year,plotMarkersYear()):(fromDate="01/01/"+window.yearClickedBarChart,document.getElementById("date-custom-from").value=fromDate,window.yearClickedBarChart==yearCurrent?toDate=today.getMonth()+"/"+today.getDate()+"/"+yearCurrent:toDate="12/31/"+window.yearClickedBarChart,document.getElementById("date-custom-to").value=toDate,updateDatePickers(),plotMarkersCustomDate())}))}))}function newRectsHandler(){window.innerWidth>=800&&setTimeout((function(){bindRectsClickHandler(),barChart.contentDocument.getElementById("select-series").addEventListener("change",bindRectsClickHandler)}),200)}barChart.addEventListener("load",newRectsHandler),window.addEventListener("resize",newRectsHandler)}window.addEventListener("beforeunload",(function(){dateType.selectedIndex=0,dateYear.value=yearCurrent}));