const center=L.latLng(39.7461,-75.5498),zoom=14,map=L.map("map").setView(center,14).setMaxBounds(L.latLngBounds([[39.8261,-75.4698],[39.6661,-75.6298]]));L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>\n                 <div>Icons made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>',minZoom:13,maxZoom:18,ext:"png"}).addTo(map),window.addEventListener("load",(function(){map.invalidateSize()}));const svgTemplate=L.Util.template(' <svg version="1.1" class="leaflet-data-marker" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 15.847 15.847" style="enable-background:new 0 0 15.847 15.847;" xml:space="preserve">     <path d="M15.847,5.228V4.052h-0.065V2.931h-0.064V2.534H15.26V2.93c0,0-11.083,0.078-13.018,0         c-0.296,0-1.986,0.167-0.291,2.773c0,0,0.77,1.168-0.285,2.471c-1.041,1.284-1.51,3.885-1.632,4.671H0v0.468h4.803v-0.468v-0.43         c-2.075,0.382,1.434-4.447,1.278-3.634c0.113,0.029,0.23,0.047,0.352,0.047h1.25c0.772,0,1.797-0.826,1.797-1.599         c0-0.335-0.118-0.642-0.314-0.883h6.185l0.2-0.736h0.262V5.254H15.77l0.011-0.026H15.847z M7.685,8.144h-1.25         c-0.092,0-0.181-0.015-0.265-0.04c0.073-0.429,0.129-0.813,0.169-1.112c0.105,0.347,0.31,0.71,0.713,0.867         C7.08,7.87,7.109,7.875,7.138,7.875c0.094,0,0.184-0.058,0.221-0.15c0.047-0.123-0.014-0.26-0.136-0.308         c-0.417-0.162-0.5-0.792-0.516-1.068h1.205c0.393,0.102,0.686,0.459,0.686,0.883C8.598,7.734,8.188,8.144,7.685,8.144z         M14.098,5.612H7.924l1.072-0.357h5.102C14.098,5.255,14.098,5.612,14.098,5.612z"/> </svg>'),icon=L.divIcon({className:"leaflet-data-marker",html:svgTemplate});function getIconSize(){const mapStyles=window.getComputedStyle(document.getElementById("map")),mapWidth=parseFloat(mapStyles.getPropertyValue("width")),mapHeight=parseFloat(mapStyles.getPropertyValue("height")),vmin=Math.min(mapWidth,mapHeight),currentZoom=map.getZoom();return.03*vmin+1.2*currentZoom}function adjustIcons(){const size=getIconSize(),sizeCSS=String(size)+"px",anchorCSS=-.5*size+"px";document.querySelectorAll(".leaflet-marker-icon").forEach((function(marker){const svg=marker.querySelector("svg");svg.style.width=sizeCSS,svg.style.height=sizeCSS,marker.style.marginLeft=anchorCSS,marker.style.marginTop=anchorCSS})),icon.options.iconSize=[size,size]}function loadCurrentData(response){return new Promise((function(resolve){response.arrayBuffer().then((function(buffer){const blob=new Blob([buffer],{type:"application/zip"}),zip=new JSZip;zip.loadAsync(blob).then((function(zip){return zip.file("incidentDataCurrent.csv").async("string")})).then((function(dataAsString){currentData=d3.csvParse(dataAsString),resolve(currentData)}))}))}))}map.on("zoomstart",adjustIcons).on("resize",adjustIcons);const markers=L.layerGroup();function plotCurrentData(currentData){return new Promise((function(resolve){for(adjustIcons(),i=0;i<currentData.length;i++)L.marker([currentData[i].LAT,currentData[i].LONG],{icon:icon}).on("click",markerClickHandler).addTo(markers);markers.addTo(map),resolve(currentData)}))}let dataYearly={},yearDataYearly=2011;const yearCurrent=document.querySelector('#date-year option[selected="selected"]').value;for(;yearDataYearly<=yearCurrent;)dataYearly[yearDataYearly]=[],yearDataYearly++;let year=yearCurrent;function prepareDataObjects(intialData){for(dataChron=currentData,i=0;i<dataChron.length;i++){let d=dataChron[i];delete d.YEAR,dataYearly[year].push({LAT:d.LAT,LONG:d.LONG,HTML:d.HTML})}fetch("data/incidentDataPrevious.zip").then((function(response){response.arrayBuffer().then((function(buffer){var blob=new Blob([buffer],{type:"application/zip"}),zip;(new JSZip).loadAsync(blob).then((function(zip){return incidentData=zip.file("incidentDataPrevious.csv").async("string")})).then((function(dataAsString){return d3.csvParse(dataAsString)})).then((function(data){data.forEach((function(d){dataYearly[d.YEAR].push({LAT:d.LAT,LONG:d.LONG,HTML:d.HTML}),delete d.YEAR,dataChron.push(d)}))}))}))}))}function plotMarkersYear(){markers.clearLayers();const dataYear=dataYearly[year];for(i=0;i<dataYear.length;i++)L.marker([dataYear[i].LAT,dataYear[i].LONG],{icon:icon}).on("click",markerClickHandler).addTo(markers);markers.addTo(map)}function adjustTimeZoneOffset(d){return new Date(d.getTime()+6e4*d.getTimezoneOffset())}function plotMarkersCustomDate(){markers.clearLayers();const fromDate=adjustTimeZoneOffset(new Date(document.getElementById("date-custom-from").value)),toDate=adjustTimeZoneOffset(new Date(document.getElementById("date-custom-to").value));for(i=0;i<dataChron.length;i++){let d=dataChron[i];if(d.DATE=adjustTimeZoneOffset(new Date(d.DATE)),d.DATE>=fromDate)d.DATE<=toDate&&L.marker([d.LAT,d.LONG],{icon:icon}).on("click",markerClickHandler).addTo(markers);else if(d.Date<fromDate)break}markers.addTo(map)}function updateDatePickers(){const fromDate=document.getElementById("date-custom-from").value,toDate=document.getElementById("date-custom-to").value;fromDateOptions.maxDate=toDate,fromDateOptions.defaultDate=fromDate,flatpickr("#date-custom-from",fromDateOptions),toDateOptions.minDate=fromDate,toDateOptions.defaultDate=toDate,flatpickr("#date-custom-to",toDateOptions)}function dateTypeChangeHandler(){const dateType=document.getElementById("date-type").value;if("custom"==dateType){if(document.getElementById("date-year").style.display="none",document.getElementById("date-custom").style.display="block","undefined"==typeof heightCustom&&(heightYear=window.getComputedStyle(document.getElementById("map")).getPropertyValue("height"),heightDateCustom=parseFloat(window.getComputedStyle(document.getElementById("date-custom")).getPropertyValue("height")),heightCustom=parseFloat(heightYear)-heightDateCustom+"px"),document.getElementById("map").style.height=heightCustom,document.getElementById("side-panel").style.height=heightCustom,document.getElementById("date-custom-from").value="1/1/"+year,year==yearCurrent){const today=new Date;document.getElementById("date-custom-to").value=String(today.getMonth()+1)+"/"+today.getDate()+"/"+year}else document.getElementById("date-custom-to").value="12/31/"+year;updateDatePickers()}else{const dateYear=document.getElementById("date-year");dateYear.style.display="unset",document.getElementById("date-custom").style.display="none",document.getElementById("map").style.height=heightYear,document.getElementById("side-panel").style.height=heightYear,year=document.getElementById("date-custom-from").value.substring(6),dateYear.value=year,plotMarkersYear()}}function unselectMarker(){const markerSelectedOld=document.querySelector(".marker-selected");markerSelectedOld&&markerSelectedOld.classList.remove("marker-selected")}function selectMarker(){unselectMarker(),markerSelectedNew.classList.add("marker-selected"),document.getElementById("side-panel-default").style.display="none";const incident=document.querySelector(".incident");incident&&incident.parentNode.removeChild(incident);const dNode=document.createRange().createContextualFragment(d.HTML);document.getElementById("side-panel").append(dNode)}function markerClickHandler(e){const markerSelectedOld=document.querySelector(".marker-selected");if(markerSelectedNew=e.target._icon,markerSelectedOld==markerSelectedNew)defaultSidePanel();else{const latlngClicked=this._latlng,latClicked=latlngClicked.lat,longClicked=latlngClicked.lng,dateType=document.getElementById("date-type").value;if("year"==dateType){var dataYear=dataYearly[year];for(let i=0;i<dataYear.length;i++)if(d=dataYear[i],d.LAT==latClicked&&d.LONG==longClicked){selectMarker();break}}else{const fromDate=adjustTimeZoneOffset(new Date(document.getElementById("date-custom-from").value)),toDate=adjustTimeZoneOffset(new Date(document.getElementById("date-custom-to").value));for(let i=0;i<dataChron.length;i++){d=dataChron[i];const date=adjustTimeZoneOffset(new Date(d.DATE));if(d.LAT==latClicked&&d.LONG==longClicked&&date>=fromDate&&date<=toDate){selectMarker();break}}}}}function defaultSidePanel(){if("none"==document.getElementById("side-panel-default").style.display){unselectMarker(),document.getElementById("side-panel-default").style.display="unset";const incident=document.querySelector(".incident");incident.parentNode.removeChild(incident)}}fetch("data/incidentDataCurrent.zip").then(loadCurrentData).then(plotCurrentData).then(prepareDataObjects),document.getElementById("date-year").addEventListener("change",(function(){year=this.value,plotMarkersYear()})),document.querySelectorAll("#date-custom-from, #date-custom-to").forEach((function(dateCustom){dateCustom.addEventListener("change",plotMarkersCustomDate)})),fromDateOptions={dateFormat:"m/d/Y",minDate:"01/01/2011"},toDateOptions={dateFormat:"m/d/Y",maxDate:"today"},document.getElementById("date-custom-to").addEventListener("change",(function(){fromDateOptions.maxDate=document.getElementById("date-custom-to").value,fromDateOptions.defaultDate=document.getElementById("date-custom-from").value,flatpickr("#date-custom-from",fromDateOptions)})),document.getElementById("date-custom-from").addEventListener("change",(function(){toDateOptions.minDate=document.getElementById("date-custom-from").value,toDateOptions.defaultDate=document.getElementById("date-custom-to").value,flatpickr("#date-custom-to",toDateOptions)})),document.getElementById("date-type").addEventListener("change",dateTypeChangeHandler),map.on("click",defaultSidePanel),bindRectsClickHandler=function(){barChart.contentDocument.querySelectorAll("#svg-bar-chart rect").forEach((function(rect){rect.addEventListener("click",(function(){"year"==document.getElementById("date-type").value?year!=window.yearClickedBarChart&&(year=window.yearClickedBarChart,document.getElementById("date-year").value=year,plotMarkersYear()):(fromDate="01/01/"+window.yearClickedBarChart,document.getElementById("date-custom-from").value=fromDate,window.yearClickedBarChart==yearCurrent?(today=new Date,toDate=today.getMonth()+"/"+today.getDate()+"/"+yearCurrent):toDate="12/31/"+window.yearClickedBarChart,document.getElementById("date-custom-to").value=toDate,updateDatePickers(),plotMarkersCustomDate())}))}))},window.addEventListener("load",(function(){setTimeout((function(){barChart=window.frames.barChart,bindRectsClickHandler(),barChart.contentDocument.querySelector("#select-series").addEventListener("change",bindRectsClickHandler)}),100)}));