const center=L.latLng(39.7461,-75.5498),zoom=14,map=L.map("map").setView(center,14).setMaxBounds(L.latLngBounds([[39.8261,-75.4698],[39.6661,-75.6298]]));L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>\n                 <div>Icons made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>',subdomains:"abcd",minZoom:13,maxZoom:18,ext:"png"}).addTo(map);var markers=L.layerGroup(),markerSelected=L.layerGroup();function getIconSize(){var vmin,currentZoom=map.getZoom(),mapHeight=$("#map").height(),mapWidth=$("#map").width();return.03*(vmin=mapHeight>mapWidth?mapWidth:mapHeight)+1.2*currentZoom}window.onload=function(){map.invalidateSize()};const svgTemplate=L.Util.template(' <svg version="1.1" class="leaflet-data-marker" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 15.847 15.847" style="enable-background:new 0 0 15.847 15.847;" xml:space="preserve">     <path d="M15.847,5.228V4.052h-0.065V2.931h-0.064V2.534H15.26V2.93c0,0-11.083,0.078-13.018,0         c-0.296,0-1.986,0.167-0.291,2.773c0,0,0.77,1.168-0.285,2.471c-1.041,1.284-1.51,3.885-1.632,4.671H0v0.468h4.803v-0.468v-0.43         c-2.075,0.382,1.434-4.447,1.278-3.634c0.113,0.029,0.23,0.047,0.352,0.047h1.25c0.772,0,1.797-0.826,1.797-1.599         c0-0.335-0.118-0.642-0.314-0.883h6.185l0.2-0.736h0.262V5.254H15.77l0.011-0.026H15.847z M7.685,8.144h-1.25         c-0.092,0-0.181-0.015-0.265-0.04c0.073-0.429,0.129-0.813,0.169-1.112c0.105,0.347,0.31,0.71,0.713,0.867         C7.08,7.87,7.109,7.875,7.138,7.875c0.094,0,0.184-0.058,0.221-0.15c0.047-0.123-0.014-0.26-0.136-0.308         c-0.417-0.162-0.5-0.792-0.516-1.068h1.205c0.393,0.102,0.686,0.459,0.686,0.883C8.598,7.734,8.188,8.144,7.685,8.144z         M14.098,5.612H7.924l1.072-0.357h5.102C14.098,5.255,14.098,5.612,14.098,5.612z"/> </svg>'),icon=L.divIcon({className:"leaflet-data-marker",html:svgTemplate});function resizeIcons(){const size=getIconSize();icon.options.iconSize=[size,size];const w=String(size)+"px";document.querySelectorAll("#map svg:not(.leaflet-zoom-animated)").forEach((function(svg){svg.style.width=w,svg.style.height=w}))}var dataChron,yearCurrent,year;map.on("resize",resizeIcons).on("zoomstart",resizeIcons);var dataYearly={},yearAll=2011;function adjustTimeZone(d){return new Date(d.getTime()+6e4*d.getTimezoneOffset())}function initializeDatePicker(from,to){sharedAttributes={changeMonth:!0,changeYear:!0,minDate:adjustTimeZone(new Date("2011-01-01")),maxDate:adjustTimeZone(new Date),showAnim:"slideDown"},$("#date-val-from").datepicker(sharedAttributes),$("#date-val-to").datepicker(sharedAttributes),$("#date-val-from").datepicker("setDate",adjustTimeZone(from)),$("#date-val-to").datepicker("setDate",adjustTimeZone(to))}function changeDateType(){var dateType=$("#date-type").val();if($(window).width()>800?l="0.85":l="1.5","custom"==dateType)year=$("#date-val").val(),$("#date-val").remove(),$("#date-container").append('<div id="date-range"><input type="text" id="date-val-from" class="custom-date"/><span>&nbsp;-&nbsp;</span><input type="text" id="date-val-to" class="custom-date"/></div>'),$("#date-range").css({"padding-top":l+"vmin","padding-bottom":l+"vmin","background-color":"lightgray","border-top":l+"vmin solid gray"}),$("#date-container").css({"padding-bottom":"0"}),fromDate=new Date(year+"-01-01"),toDate=new Date(year+"-12-31"),initializeDatePicker(fromDate,toDate),$(".custom-date").change(plotCustomDate);else{year=Number($("#date-val-from").val().substring(6)),$("#date-range").remove(),$("#date-container").append('<select id="date-val"></select>');for(var yearAll=2011;yearAll<=yearCurrent;)yearAll==year?$("#date-val").append('<option value="'+yearAll+'" selected = "selected">'+yearAll+"</option>"):$("#date-val").append('<option value="'+yearAll+'">'+yearAll+"</option>"),yearAll++;$("#date-val").selectmenu({change:changeYear}),$(".ui-icon").remove(),$("#date-container").css({"padding-bottom":l+"vmin"}),markers.clearLayers(),markerSelected.clearLayers(),plotYearly()}adjustHeight(),$(window).width()>800&&adjustIframe(),resizeIcons()}function plotYearly(){if(year=Number($("#date-val").val())){for(i=0;i<dataYearly[year].length;i++)L.marker([dataYearly[year][i].LAT,dataYearly[year][i].LONG],{icon:icon}).on("click",onClick).addTo(markers);markers.addTo(map)}}function changeYear(){markers.clearLayers(),markerSelected.clearLayers(),plotYearly(),resizeIcons()}function plotCustomDate(){markers.clearLayers(),markerSelected.clearLayers();const fromDateRange=adjustTimeZone(new Date($("#date-val-from").val())),toDateRange=adjustTimeZone(new Date($("#date-val-to").val()));var flag=0;for(i=0;i<dataChron.length;i++){let d=dataChron[i];if(d.DATE=adjustTimeZone(new Date(d.DATE)),d.DATE>=fromDateRange&&d.DATE<=toDateRange)L.marker([d.LAT,d.LONG],{icon:icon}).on("click",onClick).addTo(markers),0==flag&&flag++;else if(1==flag)break}markers.addTo(map),resizeIcons()}d3.csv("data/yearlyData.csv").then((function(data){for(yearCurrent=data[0].year;yearAll<=yearCurrent;)dataYearly[yearAll]=[],yearAll++;year=Number(yearCurrent)})),fetch("data/incidentDataCurrent.zip").then((function(response){response.arrayBuffer().then((function(buffer){var blob=new Blob([buffer],{type:"application/zip"}),zip;(new JSZip).loadAsync(blob).then((function(zip){return zip.file("incidentDataCurrent.csv").async("string")})).then((function(dataAsString){return d3.csvParse(dataAsString)})).then((function(data){for(dataChron=data,i=0;i<dataChron.length;i++){delete dataChron[i].YEAR;let d=dataChron[i];dataYearly[yearCurrent].push({LAT:d.LAT,LONG:d.LONG,HTML:d.HTML}),L.marker([d.LAT,d.LONG],{icon:icon}).on("click",onClick).addTo(markers)}markers.addTo(map)})),resizeIcons()}))})).then((function(){fetch("data/incidentDataPrevious.zip").then((function(response){response.arrayBuffer().then((function(buffer){var blob=new Blob([buffer],{type:"application/zip"}),zip;(new JSZip).loadAsync(blob).then((function(zip){return incidentData=zip.file("incidentDataPrevious.csv").async("string")})).then((function(dataAsString){return d3.csvParse(dataAsString)})).then((function(data){data.forEach((function(d){dataChron.push(d),dataYearly[d.YEAR].push({LAT:d.LAT,LONG:d.LONG,HTML:d.HTML})}))}))}))}))})),$("#date-type").selectmenu({change:changeDateType}),$((function(){$(".ui-icon").remove(),$("#map").css("z-index","0")})),$("#date-val").selectmenu({change:changeYear});var seriesVal=0;function unselectMarker(){const markerSelectedOld=document.querySelector(".marker-selected");markerSelectedOld&&markerSelectedOld.classList.remove("marker-selected")}function onClick(e){const markerSelectedOld=document.querySelector(".marker-selected"),markerSelectedNew=e.target._icon;if(markerSelectedOld==markerSelectedNew)defaultSidePanel();else{var seriesValChange=$("iframe").contents().find("#seriesSelect").val();seriesValChange&&(seriesVal=seriesValChange);const lat=this._latlng.lat,long=this._latlng.lng;var dateType;if("custom"!=$("#date-type").val()){for(i=0;i<dataYearly[year].length;i++)if(dataYearly[year][i].LAT==lat&&dataYearly[year][i].LONG==long){$("#side-panel").html(dataYearly[year][i].HTML),unselectMarker(),markerSelectedNew.classList.add("marker-selected");break}}else{const fromDateRange=adjustTimeZone(new Date($("#date-val-from").val())),toDateRange=adjustTimeZone(new Date($("#date-val-to").val()));var flag=0;for(i=0;i<dataChron.length;i++){let d=dataChron[i];if(d.DATE=adjustTimeZone(new Date(d.DATE)),d.LAT==lat&&d.LONG==long&&d.DATE>=fromDateRange&&d.DATE<=toDateRange)$("#side-panel").html(d.HTML),unselectMarker(),markerSelectedNew.classList.add("marker-selected"),0==flag&&flag++;else if(1==flag)break}}flagMarkerSelected=!0}}var flagMarkerSelected=!1;function defaultSidePanel(){if(markerSelected.clearLayers(),flagMarkerSelected){const seriesValReport=seriesVal;$("#side-panel").html(txt),adjustIframe(),changeYearClickChart(),flagMarkerSelected=!1,$("iframe").on("load",(function(){$("iframe").contents().find("#seriesSelect").remove().val(seriesValReport)})),$(".marker-selected").removeClass("marker-selected")}}function adjustHeight(){$(window).outerWidth(!0)<=800?($("#map").css("height","45vh"),$("#side-panel").css("height",$(window).height()-$("#top").height()-$("#map").height())):($("#map").height($(window).height()-$("#top").height()),$("#side-panel").height($(window).height()-$("#top").height()-parseInt($("#side-panel").css("padding-bottom"))))}function barChart(){var dateType=$("#date-type").val();$(window).width()<=800?("custom"!=dateType?$("#date-container").css({"padding-bottom":"1.5vmin"}):$("#date-range").css({"padding-top":"1.5vmin","padding-bottom":"1.5vmin","border-top":"1.5vmin solid gray"}),$("#side-panel iframe").remove(),txt=txtNoIframe):0==$("#side-panel iframe").length&&("custom"!=dateType?$("#date-container").css({"padding-bottom":".85vmin"}):$("#date-range").css({"padding-top":"0.85vmin","padding-bottom":"0.85vmin","border-top":"0.85vmin solid gray"}),3==$("#side-panel p").length&&$("#side-panel").append(iframeHTML),txt=txtNoIframe+iframeHTML,window.changeYearListener=function(){const rectsNum=$("iframe").contents().find("rect.remove.black").length;rectsNUM=yearCurrent-2010,rectsNum==rectsNUM?$("iframe").contents().find("rect.remove").on("click",(function(){setTimeout((function(){$("#date-val").val()?($("#date-val").val(window.yearClicked),$("#date-val").selectmenu("refresh"),changeYear()):(fromDate="01/01/"+window.yearClicked,window.yearClicked==yearCurrent?(today=new Date,toDate=today.getMonth()+"/"+today.getDate()+"/"+yearCurrent):toDate="12/31/"+window.yearClicked,$("#date-val-from").val(fromDate),$("#date-val-to").val(toDate),plotCustomDate())}),50)})):setTimeout(changeYearListener,100)},changeYearClickChart(),$(adjustIframe),$(window).resize(adjustIframe),$(window).resize((function(){$("iframe").attr("src","barChart.html")})))}map.on("click",defaultSidePanel),$(adjustHeight),$(window).resize(adjustHeight),adjustIframe=function(){var iframe;$("iframe").css("transform","translate(0,"+(($(window).height()-$("#top").height()-vh(50))/2-2*$("#side-panel p").outerHeight())+"px)")},changeYearClickChart=function(){$("iframe").on("load",(function(){changeYearListener(),$("iframe").contents().find("ul").on("click",(function(){changeYearListener()}))}))},vh=function(v){var h;return v*Math.max(document.documentElement.clientHeight,window.innerHeight||0)/100},txt=$("#side-panel").html(),iframeHTML="<iframe src='barChart.html' id='chart'></iframe>",txtNoIframe=txt.replace(iframeHTML,""),barChart(),$(window).resize(barChart);